<!-- chatbot.component.html -->
<div class="chatbot-page">
  <!-- Header -->
  <header class="chatbot-header">
    <div class="header-content">
      <!-- Bot√≥n men√∫ m√≥vil -->
      <button class="mobile-menu-btn" (click)="toggleSidebar()">
        <span class="material-symbols-outlined">menu</span>
      </button>

      <button class="back-button" routerLink="/marketplace">
        <span class="material-icons">arrow_back</span>
        <span>Volver al inicio</span>
      </button>
      <div class="header-title">
        <h1>Asistente Virtual</h1>
        <p class="subtitle">Ra√≠cesMX - Conectando artesanos y compradores</p>
      </div>
      <div class="header-status">
        <span class="status-dot"></span>
        <span class="status-text">En l√≠nea</span>
      </div>
    </div>
  </header>

  <!-- Overlay para cerrar sidebar -->
  <div class="sidebar-overlay" *ngIf="sidebarOpen" (click)="closeSidebar()"></div>

  <!-- Contenido principal -->
  <main class="chatbot-main">
    <div class="chatbot-container">
      <!-- Panel lateral izquierdo -->
      <aside class="chatbot-sidebar" [class.open]="sidebarOpen">
        <div class="sidebar-header">
          <div class="sidebar-avatar">
            <span class="material-symbols-outlined">robot_2</span>
          </div>
          <h2>Ra√≠cesBot</h2>
          <p class="sidebar-subtitle">Tu asistente virtual</p>
        </div>

        <div class="sidebar-section">
          <h3 class="section-title">
            <span class="material-symbols-outlined icon-sm">category</span>
            Categor√≠as de Ayuda
          </h3>
          <div class="help-categories">
            <button
              *ngFor="let category of helpCategories"
              class="category-btn"
              (click)="selectHelpCategory(category.title)"
            >
              <span class="material-symbols-outlined">{{ category.icon }}</span>
              <div class="category-info">
                <span class="category-title">{{ category.title }}</span>
                <span class="category-desc">{{ category.desc }}</span>
              </div>
            </button>
          </div>
        </div>

        <div class="sidebar-section">
          <h3 class="section-title">
            <span class="material-symbols-outlined icon-sm">question_answer</span>
            Preguntas Frecuentes
          </h3>
          <div class="quick-questions-sidebar">
            <button
              *ngFor="let question of quickQuestions"
              class="quick-question-sidebar"
              (click)="selectQuickQuestion(question)"
            >
              {{ question }}
            </button>
          </div>
        </div>

        <div class="sidebar-footer">
          <p class="footer-text">¬øNecesitas ayuda humana?</p>
          <div class="contact-info">
            <p>
              <span class="material-symbols-outlined icon-xs">mail</span>
              soporte@raicesmx.com
            </p>
            <p>
              <span class="material-symbols-outlined icon-xs">call</span>
              55-1234-5678
            </p>
          </div>
          <button class="clear-chat-btn btn-secondary" (click)="clearChat()">
            <span class="material-symbols-outlined">delete</span>
            Limpiar conversaci√≥n
          </button>
        </div>
      </aside>

      <!-- √Årea principal del chat -->
      <div class="chatbot-content">
        <!-- Encabezado del chat -->
        <div class="chat-header">
          <div class="chat-header-left">
            <div class="chat-avatar-main">
              <span class="material-symbols-outlined">chat</span>
            </div>
            <div class="chat-info">
              <h2>Chat en vivo</h2>
              <p class="chat-description">Conversaci√≥n con nuestro asistente virtual</p>
            </div>
          </div>
          <div class="chat-stats">
            <span class="stat-item">
              <span class="material-symbols-outlined icon-xs">message</span>
              {{ messages.length }} mensajes
            </span>
            <span class="stat-separator">‚óè</span>
            <span class="stat-item">
              <span class="material-symbols-outlined icon-xs">bolt</span>
              Respuesta r√°pida
            </span>
          </div>
        </div>

        <!-- √Årea de mensajes -->
        <div class="chat-messages-area" #chatContainer>
          <!-- Mensaje de bienvenida -->
          <div class="welcome-message">
            <div class="welcome-content">
              <h3>
                <span class="material-symbols-outlined icon-lg">waving_hand</span>
                ¬°Bienvenido al asistente de Ra√≠cesMX!
              </h3>
              <p>
                Puedo ayudarte con informaci√≥n sobre productos artesanales, ventas, registro y m√°s.
              </p>
              <p>Selecciona una categor√≠a o escribe tu pregunta directamente.</p>
            </div>
          </div>

          <!-- Historial de mensajes -->
          <div class="messages-history">
            <div
              class="message-container"
              *ngFor="let message of messages; trackBy: trackByMessageId"
            >
              <div
                class="message"
                [class.user]="message.sender === 'user'"
                [class.bot]="message.sender === 'bot'"
              >
                <div class="message-avatar" *ngIf="message.sender === 'bot'">
                  <span class="material-symbols-outlined">smart_toy</span>
                </div>

                <div class="message-content">
                  <!-- ‚úÖ MENSAJE NORMAL DE TEXTO -->
                  <div class="message-bubble" *ngIf="!message.type || message.type === 'text'">
                    <p class="message-text">{{ message.text }}</p>
                    <div class="message-footer">
                      <span class="message-time">
                        <span class="material-symbols-outlined icon-micro">schedule</span>
                        {{ formatTime(message.timestamp) }}
                      </span>
                      <span class="message-sender">{{
                        message.sender === 'user' ? 'T√∫' : 'Ra√≠cesBot'
                      }}</span>
                    </div>
                  </div>

                  <!-- ‚úÖ SOLICITUD DE MAPA -->
                  <div class="message-bubble map-request" *ngIf="message.type === 'map_request'">
                    <p class="message-text">{{ message.text }}</p>

                    <div class="map-request-actions">
                      <!-- Opci√≥n 1: Geolocalizaci√≥n autom√°tica -->
                      <button
                        class="btn-location primary"
                        (click)="requestUserLocation()"
                        [disabled]="isLoadingLocation"
                      >
                        <span class="material-symbols-outlined">my_location</span>
                        <span *ngIf="!isLoadingLocation">Usar mi ubicaci√≥n actual</span>
                        <span *ngIf="isLoadingLocation">Obteniendo ubicaci√≥n...</span>
                      </button>

                      <!-- Opci√≥n 2: C√≥digo postal manual -->
                      <button
                        class="btn-location secondary"
                        (click)="toggleManualLocationInput()"
                        *ngIf="!showManualLocationInput"
                      >
                        <span class="material-symbols-outlined">pin_drop</span>
                        <span>Ingresar c√≥digo postal</span>
                      </button>

                      <!-- Input de c√≥digo postal -->
                      <div class="postal-code-input" *ngIf="showManualLocationInput">
                        <div class="input-group">
                          <input
                            type="text"
                            [(ngModel)]="manualPostalCode"
                            placeholder="Ej: 56700"
                            maxlength="5"
                            class="cp-input"
                            (keydown.enter)="searchByPostalCode()"
                            [disabled]="isLoadingPostalCode"
                          />
                          <button
                            class="btn-search-cp"
                            (click)="searchByPostalCode()"
                            [disabled]="isLoadingPostalCode || manualPostalCode.length !== 5"
                          >
                            <span class="material-symbols-outlined" *ngIf="!isLoadingPostalCode"
                              >search</span
                            >
                            <span class="loading-spinner" *ngIf="isLoadingPostalCode">
                              <span class="spinner"></span>
                            </span>
                          </button>
                        </div>

                        <!-- Estado de carga -->
                        <p class="loading-status" *ngIf="isLoadingPostalCode">
                          <span class="material-symbols-outlined icon-xs rotating">autorenew</span>
                          Obteniendo ubicaci√≥n del c√≥digo postal...
                        </p>

                        <button
                          class="btn-cancel"
                          (click)="toggleManualLocationInput()"
                          [disabled]="isLoadingPostalCode"
                        >
                          Cancelar
                        </button>
                      </div>

                      <p
                        class="location-hint"
                        *ngIf="!isLoadingLocation && !showManualLocationInput"
                      >
                        <span class="material-symbols-outlined icon-xs">info</span>
                        üí° En laptops/PCs la ubicaci√≥n autom√°tica puede ser imprecisa. Recomendamos
                        usar c√≥digo postal.
                      </p>

                      <p class="location-error" *ngIf="locationError">
                        <span class="material-symbols-outlined icon-xs">error</span>
                        {{ locationError }}
                      </p>
                    </div>

                    <div class="message-footer">
                      <span class="message-time">
                        <span class="material-symbols-outlined icon-micro">schedule</span>
                        {{ formatTime(message.timestamp) }}
                      </span>
                      <span class="message-sender">Ra√≠cesBot</span>
                    </div>
                  </div>

                  <!-- ‚úÖ MAPA CON PRODUCTOS -->
                  <div
                    class="message-bubble map-response"
                    *ngIf="message.type === 'map_response' && message.data"
                  >
                    <p class="message-text">{{ message.text }}</p>

                    <!-- Mapa interactivo -->
                    <div class="map-container" id="map-{{ message.id }}">
                      <div class="map-placeholder">
                        <p>üó∫Ô∏è Mapa interactivo cargando...</p>
                        <p class="map-info">
                          <strong>{{ message.data.products?.length || 0 }}</strong> productos en
                          <strong>{{ message.data.radius || 5 }}km</strong>
                        </p>
                      </div>

                      <!-- Lista de productos encontrados -->
                      <div class="products-list">
                        <div
                          class="product-card"
                          *ngFor="let product of message.data.products"
                          [routerLink]="['/producto', product.id]"
                        >
                          <img
                            [src]="product.images?.[0]?.imageUrl || '/assets/placeholder.webp'"
                            [alt]="product.titulo"
                            class="product-image"
                          />
                          <div class="product-info">
                            <h4 class="product-title">{{ product.titulo }}</h4>
                            <p class="product-price">${{ product.precio }} MXN</p>
                            <p class="product-distance">
                              <span class="material-symbols-outlined icon-micro">
                                location_on
                              </span>
                              {{ product.distance }}km de distancia
                            </p>
                            <p class="product-location">
                              {{ product.colonia }}, {{ product.municipio }}
                            </p>
                          </div>
                        </div>

                        <p class="no-products" *ngIf="message.data.products?.length === 0">
                          üòî No hay productos en este radio de b√∫squeda
                        </p>
                      </div>
                    </div>

                    <div class="message-footer">
                      <span class="message-time">
                        <span class="material-symbols-outlined icon-micro">schedule</span>
                        {{ formatTime(message.timestamp) }}
                      </span>
                      <span class="message-sender">Ra√≠cesBot</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Indicador de escritura -->
            <div class="typing-indicator" *ngIf="isTyping">
              <div class="typing-avatar">
                <span class="material-symbols-outlined">smart_toy</span>
              </div>
              <div class="typing-content">
                <div class="typing-dots">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <span class="typing-text">Ra√≠cesBot est√° escribiendo...</span>
              </div>
            </div>

            <!-- Preguntas sugeridas -->
            <div class="suggested-questions" *ngIf="getSuggestedQuestions().length > 0">
              <p class="suggested-title">
                <span class="material-symbols-outlined icon-xs">lightbulb</span>
                ¬øTe interesa saber tambi√©n sobre...
              </p>
              <div class="suggested-buttons">
                <button
                  *ngFor="let question of getSuggestedQuestions()"
                  class="suggested-btn"
                  (click)="selectQuickQuestion(question)"
                >
                  {{ question }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- √Årea de entrada -->
        <div class="chat-input-area">
          <div class="input-container">
            <div class="input-wrapper">
              <textarea
                [(ngModel)]="userMessage"
                (keydown)="onKeyPress($event)"
                placeholder="Escribe tu pregunta aqu√≠... Presiona Enter para enviar."
                class="chat-input"
                rows="2"
                #messageInput
              >
              </textarea>
              <button
                class="send-button"
                (click)="sendMessage()"
                [disabled]="!userMessage.trim()"
                [class.active]="userMessage.trim()"
              >
                <span class="material-symbols-outlined">send</span>
                <span class="send-text">Enviar</span>
              </button>
            </div>
            <div class="input-hints">
              <span class="hint-item">
                <span class="material-symbols-outlined icon-micro">lightbulb</span>
                Puedes preguntar sobre productos, ventas o registro
              </span>
              <span class="hint-item">
                <span class="material-symbols-outlined icon-micro">bolt</span>
                Respuesta en menos de 2 segundos
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="chatbot-footer">
    <div class="footer-content">
      <p class="footer-copyright">¬© 2024 Ra√≠cesMX - Asistente Virtual</p>
      <div class="footer-links">
        <a href="#" class="footer-link">T√©rminos de servicio</a>
        <a href="#" class="footer-link">Pol√≠tica de privacidad</a>
        <a href="#" class="footer-link">Centro de ayuda</a>
      </div>
    </div>
  </footer>
</div>
