<div class="publicar-producto-container animate-fade-in">
  <div class="form-header">
    <h1 class="text-title">Publicar Producto en Ra铆cesMX</h1>
    <p class="text-caption">Comparte tus productos artesanales y tradicionales con nuestra comunidad</p>
  </div>

  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()" class="producto-form card-base">
    
    <!-- Secci贸n 1: T铆tulo e Im谩genes (Orden modificado) -->
    <div class="form-section">
      <h2 class="text-subtitle">1. Informaci贸n B谩sica</h2>
      
      <div class="form-group">
        <label for="titulo" class="form-label">T铆tulo del producto *</label>
        <input 
          type="text" 
          id="titulo" 
          formControlName="titulo" 
          class="input-base"
          placeholder="Ej: Jarro de barro negro de Oaxaca artesanal"
        >
        <div *ngIf="productoForm.get('titulo')?.invalid && productoForm.get('titulo')?.touched" class="error-message">
          <span *ngIf="productoForm.get('titulo')?.errors?.['required']">El t铆tulo es requerido</span>
          <span *ngIf="productoForm.get('titulo')?.errors?.['minlength']">M铆nimo 10 caracteres</span>
          <span *ngIf="productoForm.get('titulo')?.errors?.['maxlength']">M谩ximo 100 caracteres</span>
        </div>
      </div>

      <!-- Im谩genes del Producto -->
      <div class="form-group">
        <div class="form-label">Im谩genes del Producto *</div>
        <p class="text-caption mb-3">Sube fotos de alta calidad. La primera imagen ser谩 la principal.</p>
        
        <div class="imagenes-section">
          <div class="imagenes-preview">
            <div *ngFor="let imagen of imagenesPrevisualizacion; let i = index" class="imagen-item">
              <img [src]="imagen" alt="Previsualizaci贸n" [class.principal]="i === 0">
              <div class="imagen-overlay">
                <span *ngIf="i === 0" class="badge-principal">Principal</span>
                <button type="button" class="btn-eliminar" (click)="removeImage(i)">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <div *ngIf="imagenesPrevisualizacion.length < 5" class="upload-box">
              <input 
                type="file" 
                id="imagenes" 
                multiple 
                accept="image/*" 
                (change)="onFileSelected($event)"
              >
              <label for="imagenes" class="upload-label">
                <div class="upload-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <span>Agregar im谩genes</span>
                <small class="text-caption">M谩ximo 5 im谩genes (5MB c/u)</small>
              </label>
            </div>
          </div>
        </div>
        <div *ngIf="archivosImagenes.length === 0 && productoForm.get('imagenes')?.touched" class="error-message">
          Debes subir al menos una imagen
        </div>
      </div>
    </div>

    <!-- Secci贸n 2: Descripci贸n y Categor铆a -->
    <div class="form-section">
      <h2 class="text-subtitle">2. Detalles del Producto</h2>

      <div class="form-group">
        <label for="descripcion" class="form-label">Descripci贸n detallada *</label>
        <textarea 
          id="descripcion" 
          formControlName="descripcion" 
          class="input-base"
          rows="6"
          placeholder="Describe tu producto detalladamente: materiales usados, t茅cnicas artesanales, historia, medidas, cuidados, etc."
        ></textarea>
        <div class="char-counter">{{ productoForm.get('descripcion')?.value?.length || 0 }}/2000</div>
        <div *ngIf="productoForm.get('descripcion')?.invalid && productoForm.get('descripcion')?.touched" class="error-message">
          <span *ngIf="productoForm.get('descripcion')?.errors?.['required']">La descripci贸n es requerida</span>
          <span *ngIf="productoForm.get('descripcion')?.errors?.['minlength']">M铆nimo 50 caracteres para una buena descripci贸n</span>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="categoria" class="form-label">Categor铆a *</label>
          <select id="categoria" formControlName="categoria" class="input-base">
            <option value="" disabled selected>Selecciona una categor铆a</option>
            <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
          </select>
          <div *ngIf="productoForm.get('categoria')?.invalid && productoForm.get('categoria')?.touched" class="error-message">
            Selecciona una categor铆a
          </div>
        </div>

        <div class="form-group">
          <label for="stock" class="form-label">Cantidad disponible *</label>
          <input 
            type="number" 
            id="stock" 
            formControlName="stock" 
            class="input-base"
            min="1"
            max="999"
          >
          <div *ngIf="productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched" class="error-message">
            <span *ngIf="productoForm.get('stock')?.errors?.['required']">La cantidad es requerida</span>
            <span *ngIf="productoForm.get('stock')?.errors?.['min']">M铆nimo 1 unidad</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci贸n 3: Precio -->
    <div class="form-section">
      <h2 class="text-subtitle">3. Precio</h2>
      
      <div class="form-group">
        <label for="precio" class="form-label">Precio (MXN) *</label>
        <div class="input-with-icon">
          <span class="input-icon">$</span>
          <input 
            type="text" 
            id="precio" 
            formControlName="precio" 
            class="input-base"
            (blur)="formatPrice($event)"
            placeholder="0.00"
          >
        </div>
        <div *ngIf="productoForm.get('precio')?.invalid && productoForm.get('precio')?.touched" class="error-message">
          <span *ngIf="productoForm.get('precio')?.errors?.['required']">El precio es requerido</span>
          <span *ngIf="productoForm.get('precio')?.errors?.['min']">El precio m铆nimo es $1 MXN</span>
        </div>
      </div>

      <!-- Informaci贸n de comisi贸n -->
      <div class="info-box bg-light p-3 rounded-md mt-3" *ngIf="productoForm.get('precio')?.value">
        <div class="d-flex justify-between align-center">
          <span class="text-caption">Comisi贸n de Ra铆cesMX (5%):</span>
          <span class="text-bold">${{ formatNumber(calcularComision()) }} MXN</span>
        </div>
        <div class="d-flex justify-between align-center mt-1">
          <span class="text-subtitle">Ganancia neta estimada:</span>
          <span class="text-bold text-primary">${{ formatNumber(calcularPrecioTotal()) }} MXN</span>
        </div>
      </div>

      <div class="form-row mt-3">
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="envioDisponible">
            <span class="text-body">Ofrecer env铆o a domicilio</span>
          </label>
        </div>
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="envioNacional">
            <span class="text-body">Env铆o a todo M茅xico</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Secci贸n 4: Ubicaci贸n con Mapa -->
    <div class="form-section">
      <h2 class="text-subtitle">4. Ubicaci贸n</h2>
      
      <div class="form-row">
        <div class="form-group">
          <label for="estado" class="form-label">Estado *</label>
          <select id="estado" formControlName="estado" class="input-base">
            <option value="" disabled selected>Selecciona tu estado</option>
            <option *ngFor="let estado of estadosMexico" [value]="estado">{{ estado }}</option>
          </select>
          <div *ngIf="productoForm.get('estado')?.invalid && productoForm.get('estado')?.touched" class="error-message">
            Selecciona tu estado
          </div>
        </div>

        <div class="form-group">
          <label for="ciudad" class="form-label">Ciudad/Municipio *</label>
          <input 
            type="text" 
            id="ciudad" 
            formControlName="ciudad" 
            class="input-base"
            placeholder="Ej: Oaxaca de Ju谩rez"
          >
          <div *ngIf="productoForm.get('ciudad')?.invalid && productoForm.get('ciudad')?.touched" class="error-message">
            La ciudad es requerida
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="colonia" class="form-label">Colonia *</label>
          <input 
            type="text" 
            id="colonia" 
            formControlName="colonia" 
            class="input-base"
            placeholder="Ej: Centro Hist贸rico"
          >
          <div *ngIf="productoForm.get('colonia')?.invalid && productoForm.get('colonia')?.touched" class="error-message">
            La colonia es requerida
          </div>
        </div>

        <div class="form-group">
          <label for="codigoPostal" class="form-label">C贸digo Postal *</label>
          <input 
            type="text" 
            id="codigoPostal" 
            formControlName="codigoPostal" 
            class="input-base"
            placeholder="5 d铆gitos"
            maxlength="5"
          >
          <div *ngIf="productoForm.get('codigoPostal')?.invalid && productoForm.get('codigoPostal')?.touched" class="error-message">
            <span *ngIf="productoForm.get('codigoPostal')?.errors?.['required']">El c贸digo postal es requerido</span>
            <span *ngIf="productoForm.get('codigoPostal')?.errors?.['pattern']">Ingresa 5 d铆gitos v谩lidos</span>
          </div>
        </div>
      </div>

      <!-- Mapa para seleccionar ubicaci贸n -->
      <div class="form-group">
        <div class="form-label">Selecciona ubicaci贸n en el mapa *</div>
        
        <div class="mapa-container">
          <!-- Controles del mapa -->
          <div class="mapa-controls mb-2">
            <button type="button" class="btn-mapa" (click)="usarUbicacionActual()">
              <i class="fas fa-location-arrow"></i> Usar mi ubicaci贸n actual
            </button>
            <button type="button" class="btn-mapa" (click)="toggleMapa()">
              <i class="fas" [class.fa-expand]="!mostrarMapa" [class.fa-compress]="mostrarMapa"></i> 
              {{ mostrarMapa ? 'Ocultar mapa' : 'Mostrar mapa completo' }}
            </button>
          </div>

          <!-- Previsualizaci贸n del mapa est谩tico -->
          <div class="mapa-preview" *ngIf="!mostrarMapa">
            <div class="mapa-placeholder" (click)="toggleMapa()">
              <div class="mapa-overlay">
                <i class="fas fa-map-marker-alt"></i>
                <p>Haz clic para seleccionar la ubicaci贸n en el mapa</p>
                <small class="text-caption" *ngIf="ubicacionSeleccionada">
                  Lat: {{ ubicacionSeleccionada.lat | number:'1.4-4' }}, Lng: {{ ubicacionSeleccionada.lng | number:'1.4-4' }}
                </small>
              </div>
            </div>
          </div>

          <!-- Mapa interactivo (simulado) -->
          <div class="mapa-interactivo" *ngIf="mostrarMapa">
            <div class="mapa-simulado">
              <div class="mapa-grid">
                <!-- Simulaci贸n de mapa con cuadr铆cula -->
                <div *ngFor="let row of [0,1,2,3,4]; let i = index" class="mapa-row">
                  <div *ngFor="let col of [0,1,2,3,4]; let j = index" 
                       class="mapa-cell" 
                       [class.selected]="esCeldaSeleccionada(i, j)"
                       (click)="seleccionarEnMapa(i, j)">
                  </div>
                </div>
                
                <!-- Marcador -->
                <div class="mapa-marker" *ngIf="celdaSeleccionada" 
                     [style.top.%]="(celdaSeleccionada.row / 5 * 100)"
                     [style.left.%]="(celdaSeleccionada.col / 5 * 100)">
                  <i class="fas fa-map-marker-alt text-primary"></i>
                </div>
              </div>
              
              <div class="mapa-instructions">
                <p class="text-caption"><i class="fas fa-mouse-pointer"></i> Haz clic en el mapa para seleccionar la ubicaci贸n exacta</p>
                <p class="text-caption" *ngIf="ubicacionSeleccionada">
                  <i class="fas fa-check-circle text-success"></i> 
                  Ubicaci贸n seleccionada: 
                  Lat {{ ubicacionSeleccionada.lat | number:'1.6-6' }}, 
                  Lng {{ ubicacionSeleccionada.lng | number:'1.6-6' }}
                </p>
              </div>
            </div>
          </div>

          <!-- Instrucciones -->
          <div class="instrucciones-mapa mt-2 p-2 bg-light rounded-md">
            <p class="text-caption mb-1">
              <i class="fas fa-info-circle text-primary"></i> 
              La ubicaci贸n en el mapa ayuda a los compradores a conocer la zona de entrega
            </p>
          </div>
        </div>
      </div>

      <!-- Informaci贸n de contacto -->
      <div class="form-row">
        <div class="form-group">
          <label for="contacto" class="form-label">Tel茅fono de contacto *</label>
          <input 
            type="tel" 
            id="contacto" 
            formControlName="contacto" 
            class="input-base"
            placeholder="10 d铆gitos"
          >
          <div *ngIf="productoForm.get('contacto')?.invalid && productoForm.get('contacto')?.touched" class="error-message">
            <span *ngIf="productoForm.get('contacto')?.errors?.['required']">El tel茅fono es requerido</span>
            <span *ngIf="productoForm.get('contacto')?.errors?.['pattern']">Ingresa 10 d铆gitos v谩lidos</span>
          </div>
        </div>

        <div class="form-group">
          <label for="email" class="form-label">Correo electr贸nico *</label>
          <input 
            type="email" 
            id="email" 
            formControlName="email" 
            class="input-base"
            placeholder="ejemplo@email.com"
          >
          <div *ngIf="productoForm.get('email')?.invalid && productoForm.get('email')?.touched" class="error-message">
            <span *ngIf="productoForm.get('email')?.errors?.['required']">El email es requerido</span>
            <span *ngIf="productoForm.get('email')?.errors?.['email']">Ingresa un email v谩lido</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci贸n 5: T茅rminos y Condiciones -->
    <div class="form-section terms-section">
      <h2 class="text-subtitle">5. T茅rminos y Condiciones</h2>
      
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="terminos" required>
          <span class="text-body">
            Acepto los 
            <a href="/terminos" target="_blank" class="text-primary">T茅rminos y Condiciones</a> 
            y la 
            <a href="/privacidad" target="_blank" class="text-primary">Pol铆tica de Privacidad</a> 
            de Ra铆cesMX *
          </span>
        </label>
      </div>
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="autenticidad" required>
          <span class="text-body">
            Certifico que este producto es aut茅ntico y hecho en M茅xico, siguiendo t茅cnicas tradicionales *
          </span>
        </label>
      </div>
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="responsabilidad" required>
          <span class="text-body">
            Me responsabilizo de la veracidad de la informaci贸n proporcionada y de la calidad del producto *
          </span>
        </label>
      </div>
    </div>

    <!-- Botones de acci贸n -->
    <div class="form-actions">
      <button type="button" class="btn-outline" (click)="navigateToMarketplace()">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button type="submit" class="btn-primary" [disabled]="productoForm.invalid || archivosImagenes.length === 0 || !ubicacionSeleccionada">
        <i class="fas fa-upload"></i> Publicar Producto
      </button>
    </div>
  </form>

  <!-- Informaci贸n de ayuda -->
  <div class="help-section mt-4 p-3 bg-light rounded-md">
    <h3 class="text-subtitle mb-2"> Consejos para una buena publicaci贸n:</h3>
    <ul class="text-caption">
      <li>Usa fotos bien iluminadas y desde diferentes 谩ngulos</li>
      <li>Describe bien los materiales y t茅cnicas artesanales</li>
      <li>Menciona las medidas exactas del producto</li>
      <li>Se espec铆fico en la ubicaci贸n para facilitar entregas</li>
      <li>Se honesto sobre el estado y disponibilidad del producto</li>
      <li>Responde r谩pidamente a las consultas de los compradores</li>
    </ul>
  </div>
</div>