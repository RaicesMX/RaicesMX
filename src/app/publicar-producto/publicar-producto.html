<div class="publicar-producto-container animate-fade-in">
  <div class="form-header">
    <h1 class="text-title">Publicar Producto en Ra√≠cesMX</h1>
    <p class="text-caption">
      Comparte tus productos artesanales y tradicionales con nuestra comunidad
    </p>
  </div>

  <form [formGroup]="productoForm" (ngSubmit)="onSubmit()" class="producto-form card-base">
    <!-- Secci√≥n 1: T√≠tulo e Im√°genes -->
    <div class="form-section">
      <h2 class="text-subtitle">1. Informaci√≥n B√°sica</h2>

      <div class="form-group">
        <label for="titulo" class="form-label">T√≠tulo del producto *</label>
        <input
          type="text"
          id="titulo"
          formControlName="titulo"
          class="input-base"
          placeholder="Ej: Jarro de barro negro de Oaxaca artesanal"
        />
        <div
          *ngIf="productoForm.get('titulo')?.invalid && productoForm.get('titulo')?.touched"
          class="error-message"
        >
          <span *ngIf="productoForm.get('titulo')?.errors?.['required']"
            >El t√≠tulo es requerido</span
          >
          <span *ngIf="productoForm.get('titulo')?.errors?.['minlength']"
            >M√≠nimo 10 caracteres</span
          >
          <span *ngIf="productoForm.get('titulo')?.errors?.['maxlength']"
            >M√°ximo 100 caracteres</span
          >
        </div>
      </div>

      <!-- Im√°genes del Producto -->
      <div class="form-group">
        <div class="form-label">Im√°genes del Producto *</div>
        <p class="text-caption mb-3">
          Sube fotos de alta calidad. La primera imagen ser√° la principal.
        </p>

        <div class="imagenes-section">
          <div class="imagenes-preview">
            <div *ngFor="let imagen of imagenesPrevisualizacion; let i = index" class="imagen-item">
              <img [src]="imagen" alt="Previsualizaci√≥n" [class.principal]="i === 0" />
              <div class="imagen-overlay">
                <span *ngIf="i === 0" class="badge-principal">Principal</span>
                <button type="button" class="btn-eliminar" (click)="removeImage(i)">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <div *ngIf="imagenesPrevisualizacion.length < 5" class="upload-box">
              <input
                type="file"
                id="imagenes"
                multiple
                accept="image/*"
                (change)="onFileSelected($event)"
              />
              <label for="imagenes" class="upload-label">
                <div class="upload-icon">
                  <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <span>Agregar im√°genes</span>
                <small class="text-caption">M√°ximo 5 im√°genes (5MB c/u)</small>
              </label>
            </div>
          </div>
        </div>
        <div
          *ngIf="archivosImagenes.length === 0 && productoForm.get('titulo')?.touched"
          class="error-message"
        >
          Debes subir al menos una imagen
        </div>
      </div>
    </div>

    <!-- Secci√≥n 2: Descripci√≥n y Categor√≠a -->
    <div class="form-section">
      <h2 class="text-subtitle">2. Detalles del Producto</h2>

      <div class="form-group">
        <label for="descripcion" class="form-label">Descripci√≥n detallada *</label>
        <textarea
          id="descripcion"
          formControlName="descripcion"
          class="input-base"
          rows="6"
          placeholder="Describe tu producto detalladamente: materiales usados, t√©cnicas artesanales, historia, medidas, cuidados, etc."
        ></textarea>
        <div class="char-counter">
          {{ productoForm.get('descripcion')?.value?.length || 0 }}/2000
        </div>
        <div
          *ngIf="
            productoForm.get('descripcion')?.invalid && productoForm.get('descripcion')?.touched
          "
          class="error-message"
        >
          <span *ngIf="productoForm.get('descripcion')?.errors?.['required']"
            >La descripci√≥n es requerida</span
          >
          <span *ngIf="productoForm.get('descripcion')?.errors?.['minlength']"
            >M√≠nimo 50 caracteres para una buena descripci√≥n</span
          >
        </div>
      </div>

      <div class="form-row">
        <!-- Categor√≠a -->
        <div class="form-group">
          <label for="categoria" class="form-label">Categor√≠a *</label>
          <select id="categoria" formControlName="categoria" class="input-base">
            <option value="" disabled selected>Selecciona una categor√≠a</option>
            <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
          </select>

          <div
            *ngIf="productoForm.get('categoria')?.invalid && productoForm.get('categoria')?.touched"
            class="error-message"
          >
            Selecciona una categor√≠a
          </div>
        </div>

        <!-- Stock -->
        <div class="form-group">
          <label for="stock" class="form-label">Cantidad *</label>
          <input
            type="number"
            id="stock"
            formControlName="stock"
            class="input-base"
            min="1"
            max="999"
          />

          <div
            *ngIf="productoForm.get('stock')?.invalid && productoForm.get('stock')?.touched"
            class="error-message"
          >
            M√≠nimo 1 unidad
          </div>
        </div>

        <!-- Unidad -->
        <div class="form-group">
          <label for="unidad" class="form-label">Unidad *</label>
          <select id="unidad" formControlName="unidad" class="input-base">
            <option value="" disabled selected>Selecciona unidad</option>
            <option value="pieza">Pieza</option>
            <option value="kg">Kilogramo</option>
            <option value="litro">Litro</option>
            <option value="paquete">Paquete</option>
            <option value="docena">Docena</option>
          </select>

          <div
            *ngIf="productoForm.get('unidad')?.invalid && productoForm.get('unidad')?.touched"
            class="error-message"
          >
            Selecciona una unidad
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n 3: Precio con Modal de Comisi√≥n -->
    <div class="form-section">
      <h2 class="text-subtitle">3. Precio y Comisi√≥n</h2>

      <div class="form-group">
        <div class="precio-header">
          <label for="precio" class="form-label">Precio (MXN) *</label>
          <button type="button" class="btn-info-comision" (click)="abrirModalComision()">
            <i class="fas fa-info-circle"></i> Ver detalles de comisi√≥n
          </button>
        </div>
        <div class="input-with-icon">
          <span class="input-icon">$</span>
          <input
            type="text"
            id="precio"
            formControlName="precio"
            class="input-base"
            (blur)="formatPrice($event)"
            placeholder="0.00"
          />
        </div>
        <div
          *ngIf="productoForm.get('precio')?.invalid && productoForm.get('precio')?.touched"
          class="error-message"
        >
          <span *ngIf="productoForm.get('precio')?.errors?.['required']"
            >El precio es requerido</span
          >
          <span *ngIf="productoForm.get('precio')?.errors?.['min']"
            >El precio m√≠nimo es $1 MXN</span
          >
        </div>
      </div>

      <!-- Informaci√≥n de comisi√≥n -->
      <div class="info-box bg-light p-3 rounded-md mt-3" *ngIf="productoForm.get('precio')?.value">
        <div class="d-flex justify-between align-center">
          <span class="text-caption">Comisi√≥n de Ra√≠cesMX ({{ porcentajeComision * 100 }}%):</span>
          <span class="text-bold text-secondary">${{ formatNumber(calcularComision()) }} MXN</span>
        </div>
        <div class="d-flex justify-between align-center mt-1">
          <span class="text-subtitle">Tu ganancia neta estimada:</span>
          <span class="text-bold text-primary">${{ formatNumber(calcularPrecioTotal()) }} MXN</span>
        </div>
      </div>
    </div>

    <!-- Secci√≥n 4: Ubicaci√≥n con Mapa Real -->
    <div class="form-section">
      <h2 class="text-subtitle">4. Ubicaci√≥n</h2>

      <div class="form-row">
        <div class="form-group">
          <label for="estado" class="form-label">Estado *</label>
          <select id="estado" formControlName="estado" class="input-base">
            <option value="" disabled selected>Selecciona tu estado</option>
            <option *ngFor="let estado of estadosMexico" [value]="estado">{{ estado }}</option>
          </select>
          <div
            *ngIf="productoForm.get('estado')?.invalid && productoForm.get('estado')?.touched"
            class="error-message"
          >
            Selecciona tu estado
          </div>
        </div>

        <div class="form-group">
          <label for="ciudad" class="form-label">Ciudad/Municipio *</label>
          <input
            type="text"
            id="ciudad"
            formControlName="ciudad"
            class="input-base"
            placeholder="Ej: Oaxaca de Ju√°rez"
          />
          <div
            *ngIf="productoForm.get('ciudad')?.invalid && productoForm.get('ciudad')?.touched"
            class="error-message"
          >
            La ciudad es requerida
          </div>
        </div>
      </div>

      <div class="form-row">
        <!-- ‚úÖ DESPU√âS: Select con lista de colonias -->
        <div class="form-group">
          <label for="colonia" class="form-label">Colonia *</label>

          <!-- Si hay colonias disponibles, mostrar select -->
          <select
            *ngIf="coloniasDisponibles.length > 0"
            id="colonia"
            formControlName="colonia"
            class="input-base"
          >
            <option value="" disabled>Selecciona una colonia</option>
            <option *ngFor="let col of coloniasDisponibles" [value]="col">
              {{ col }}
            </option>
          </select>

          <!-- Si NO hay colonias, mostrar input manual -->
          <input
            *ngIf="coloniasDisponibles.length === 0"
            type="text"
            id="colonia"
            formControlName="colonia"
            class="input-base"
            placeholder="Ej: Centro Hist√≥rico"
          />

          <!-- Mostrar contador de colonias disponibles -->
          <small class="text-caption mt-1" *ngIf="coloniasDisponibles.length > 1">
            <i class="fas fa-info-circle"></i>
            {{ coloniasDisponibles.length }} colonias disponibles para este c√≥digo postal
          </small>

          <div
            *ngIf="productoForm.get('colonia')?.invalid && productoForm.get('colonia')?.touched"
            class="error-message"
          >
            La colonia es requerida
          </div>
        </div>

        <div class="form-group">
          <label for="codigoPostal" class="form-label">C√≥digo Postal *</label>
          <input
            type="text"
            id="codigoPostal"
            formControlName="codigoPostal"
            class="input-base"
            placeholder="5 d√≠gitos"
            maxlength="5"
          />
          <div
            *ngIf="
              productoForm.get('codigoPostal')?.invalid && productoForm.get('codigoPostal')?.touched
            "
            class="error-message"
          >
            <span *ngIf="productoForm.get('codigoPostal')?.errors?.['required']"
              >El c√≥digo postal es requerido</span
            >
            <span *ngIf="productoForm.get('codigoPostal')?.errors?.['pattern']"
              >Ingresa 5 d√≠gitos v√°lidos</span
            >
          </div>
        </div>
      </div>
      <!-- Despu√©s del c√≥digo postal (en el HTML) -->

      <!-- Mapa con API real (Geoapify Free Tier) -->
      <div class="form-group">
        <div class="form-label">Selecciona tu ubicaci√≥n exacta en el mapa *</div>

        <div class="mapa-container-real">
          <!-- Controles del mapa -->
          <div class="mapa-header">
            <div class="mapa-coordenadas">
              <i class="fas fa-map-marker-alt text-primary"></i>
              <span class="text-caption" *ngIf="ubicacionSeleccionada">
                Lat: {{ ubicacionSeleccionada.lat | number: '1.6-6' }}, Lng:
                {{ ubicacionSeleccionada.lng | number: '1.6-6' }}
              </span>
              <span class="text-caption" *ngIf="!ubicacionSeleccionada">
                Haz clic en el mapa para seleccionar ubicaci√≥n
              </span>
            </div>
          </div>

          <!-- Mapa real con API de Geoapify (gratis) -->
          <div class="mapa-real" (click)="seleccionarUbicacionManual($event)" #mapaContainer>
            <!-- Imagen del mapa est√°tico -->
            <div class="mapa-imagen-container">
              <img [src]="getMapaUrl()" alt="Mapa de ubicaci√≥n" class="mapa-imagen-real" />

              <!-- Marcador de ubicaci√≥n -->
              <div
                class="mapa-marcador-real"
                *ngIf="mostrarMarcador"
                [style.top.px]="marcadorPosicion.y"
                [style.left.px]="marcadorPosicion.x"
              >
                <i class="fas fa-map-pin text-primary"></i>
                <div class="marcador-punto-real"></div>
              </div>

              <!-- Instrucciones overlay -->
              <div class="mapa-instrucciones-real">
                <p><i class="fas fa-mouse-pointer"></i> Haz clic para marcar tu ubicaci√≥n exacta</p>
              </div>
            </div>
          </div>
          <!-- Direcci√≥n detallada -->
          <div class="direccion-detallada mt-3">
            <h3 class="text-subtitle">Direcci√≥n detallada</h3>

            <div class="form-row">
              <!-- Calle -->
              <div class="form-group">
                <label for="calle" class="form-label">Calle *</label>
                <input
                  type="text"
                  id="calle"
                  formControlName="calle"
                  class="input-base"
                  placeholder="Ej: Avenida Ju√°rez"
                />

                <div
                  *ngIf="productoForm.get('calle')?.invalid && productoForm.get('calle')?.touched"
                  class="error-message"
                >
                  La calle es requerida
                </div>
              </div>

              <!-- N√∫mero -->
              <div class="form-group">
                <label for="numero" class="form-label">N√∫mero *</label>
                <input
                  type="text"
                  id="numero"
                  formControlName="numero"
                  class="input-base"
                  placeholder="Ej: 123"
                />

                <div
                  *ngIf="productoForm.get('numero')?.invalid && productoForm.get('numero')?.touched"
                  class="error-message"
                >
                  El n√∫mero es requerido
                </div>
              </div>
            </div>

            <!-- Referencia -->
            <div class="form-group">
              <label for="referencia" class="form-label">Referencia</label>
              <input
                type="text"
                id="referencia"
                formControlName="referencia"
                class="input-base"
                placeholder="Ej: Frente a la iglesia, casa azul"
              />
            </div>
          </div>

          <!-- Instrucciones actualizadas -->
          <div class="instrucciones-mapa-actualizadas mt-2 p-3 bg-light rounded-md">
            <p class="text-caption mb-1">
              <i class="fas fa-info-circle text-primary"></i>
              La ubicaci√≥n exacta permite a los compradores calcular distancias y coordinar entregas
              personalizadas
            </p>
          </div>

          <!-- Leyenda del mapa -->
          <div class="mapa-leyenda-real">
            <div class="leyenda-item">
              <i class="fas fa-map-pin text-primary"></i>
              <span class="text-caption">Tu ubicaci√≥n seleccionada</span>
            </div>
            <div class="leyenda-item">
              <i class="fas fa-city text-secondary"></i>
              <span class="text-caption">Centro de la ciudad m√°s cercano</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n 5: T√©rminos y Condiciones -->
    <div class="form-section terms-section">
      <h2 class="text-subtitle">5. T√©rminos y Condiciones</h2>

      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="terminos" required />
          <span class="text-body">
            Acepto los
            <a href="/terminos" target="_blank" class="text-primary">T√©rminos y Condiciones</a>
            y la
            <a href="/privacidad" target="_blank" class="text-primary">Pol√≠tica de Privacidad</a>
            de Ra√≠cesMX *
          </span>
        </label>
      </div>
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="autenticidad" required />
          <span class="text-body">
            Certifico que este producto es aut√©ntico y hecho en M√©xico, siguiendo t√©cnicas
            tradicionales *
          </span>
        </label>
      </div>
      <div class="form-group checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" id="responsabilidad" required />
          <span class="text-body">
            Me responsabilizo de la veracidad de la informaci√≥n proporcionada y de la calidad del
            producto *
          </span>
        </label>
      </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="form-actions">
      <button type="button" class="btn-outline" (click)="navigateToMarketplace()">
        <i class="fas fa-times"></i> Cancelar
      </button>
      <button
        type="submit"
        class="btn-primary"
        [disabled]="productoForm.invalid || archivosImagenes.length === 0"
      >
        <i class="fas fa-upload"></i> Publicar Producto
      </button>
    </div>
  </form>

  <!-- Modal de Comisi√≥n -->
  <div class="modal-overlay" *ngIf="mostrarModalComision">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-exclamation-circle text-secondary"></i>
          Informaci√≥n sobre Comisiones
        </h3>
        <button type="button" class="modal-close" (click)="cerrarModalComision()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <div class="comision-info">
          <div class="comision-icon">
            <i class="fas fa-percentage text-primary"></i>
          </div>
          <div class="comision-text">
            <h4 class="comision-title">¬°Recuerda que Ra√≠cesMX cobra comisi√≥n por cada venta!</h4>
            <p class="comision-description">
              Para mantener nuestra plataforma y apoyar a los artesanos, cobramos una comisi√≥n del
              <span class="text-bold text-primary">{{ porcentajeComision * 100 }}%</span> sobre el
              precio de venta de cada producto.
            </p>

            <div class="ejemplo-comision">
              <h5 class="ejemplo-title">Ejemplo:</h5>
              <div class="ejemplo-item">
                <span>Si vendes un producto en:</span>
                <span class="text-bold">${{ getEjemploComision().precio }} MXN</span>
              </div>
              <div class="ejemplo-item">
                <span>Comisi√≥n de Ra√≠cesMX ({{ porcentajeComision * 100 }}%):</span>
                <span class="text-bold text-secondary"
                  >${{ formatNumber(getEjemploComision().comision) }} MXN</span
                >
              </div>
              <div class="ejemplo-item total">
                <span>Tu ganancia neta ser√°:</span>
                <span class="text-bold text-primary"
                  >${{ formatNumber(getEjemploComision().ganancia) }} MXN</span
                >
              </div>
            </div>

            <div class="comision-consejo">
              <i class="fas fa-lightbulb text-warning"></i>
              <p>
                <strong>Consejo:</strong> Establece tus precios considerando esta comisi√≥n para
                asegurar una ganancia justa.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-primary" (click)="cerrarModalComision()">
          <i class="fas fa-check"></i> Entendido
        </button>
      </div>
    </div>
  </div>

  <!-- Informaci√≥n de ayuda ACTUALIZADA -->
  <div class="help-section mt-4 p-3 bg-light rounded-md">
    <h3 class="text-subtitle mb-2">üìù Consejos para una buena publicaci√≥n:</h3>
    <ul class="text-caption">
      <li>Usa fotos bien iluminadas y desde diferentes √°ngulos</li>
      <li>Describe bien los materiales y t√©cnicas artesanales</li>
      <li>Menciona las medidas exactas del producto</li>
      <li>Se espec√≠fico en la ubicaci√≥n</li>
      <li>Se honesto sobre el estado y disponibilidad del producto</li>
      <li>Responde r√°pidamente a las consultas de los compradores</li>
    </ul>
  </div>
</div>
