<!-- src/app/carrito/carrito.html - VERSIÓN COMPLETA CON 4 PASOS -->
<div class="carrito-container">
  <!-- ========== HERO SECTION CON PROGRESO ========== -->
  <section class="carrito-hero">
    <div class="hero-pattern"></div>

    <!-- Pasos del checkout -->
    <div class="hero-checkout-flow">
      <div class="checkout-steps">
        <!-- PASO 1: Carrito -->
        <div
          class="step"
          [class.active]="pasoActual === 0"
          [class.completed]="pasoActual > 0"
          (click)="irAPaso(0)"
        >
          <div class="step-number">1</div>
          <div class="step-content">
            <div class="step-icon">
              <i class="material-icons">{{ pasoActual > 0 ? 'check_circle' : 'shopping_cart' }}</i>
            </div>
            <span class="step-label">Carrito</span>
          </div>
        </div>

        <!-- PASO 2: Datos -->
        <div
          class="step"
          [class.active]="pasoActual === 1"
          [class.completed]="pasoActual > 1"
          (click)="irAPaso(1)"
        >
          <div class="step-number">2</div>
          <div class="step-content">
            <div class="step-icon">
              <i class="material-icons">{{ pasoActual > 1 ? 'check_circle' : 'person' }}</i>
            </div>
            <span class="step-label">Datos</span>
          </div>
        </div>

        <!-- PASO 3: Pago -->
        <div class="step" [class.active]="pasoActual === 2" [class.completed]="pasoActual > 2">
          <div class="step-number">3</div>
          <div class="step-content">
            <div class="step-icon">
              <i class="material-icons">{{ pasoActual > 2 ? 'check_circle' : 'payment' }}</i>
            </div>
            <span class="step-label">Pago</span>
          </div>
        </div>

        <!-- PASO 4: Confirmación -->
        <div class="step" [class.active]="pasoActual === 3">
          <div class="step-number">4</div>
          <div class="step-content">
            <div class="step-icon">
              <i class="material-icons">check_circle</i>
            </div>
            <span class="step-label">Confirmación</span>
          </div>
        </div>
      </div>

      <!-- Resumen rápido -->
      <div class="checkout-summary" *ngIf="carrito && carrito.items.length > 0 && pasoActual < 3">
        <div class="summary-card">
          <div class="summary-header">
            <h1 class="summary-title">
              <i class="material-icons">shopping_bag</i>
              Resumen de tu compra
            </h1>
          </div>

          <div class="summary-details">
            <div class="detail-item">
              <div class="detail-label">
                <i class="material-icons">inventory_2</i>
                Productos
              </div>
              <div class="detail-value highlight">{{ carrito.items.length }} artículos</div>
            </div>

            <div class="detail-item total">
              <div class="detail-label">
                <i class="material-icons">receipt</i>
                Total
              </div>
              <div class="detail-value total-amount">
                {{ calcularTotal() | currency: 'MXN' : 'symbol' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barra de progreso -->
    <div class="progress-indicator">
      <div class="progress-bar">
        <div class="progress-fill" [style.width]="getPorcentajeProgreso() + '%'"></div>
      </div>
      <div class="progress-text">Paso {{ pasoActual + 1 }} de 4: {{ getTextoPasoActual() }}</div>
    </div>
  </section>

  <!-- ========== LOADING ========== -->
  <div class="loading-state" *ngIf="cargando">
    <div class="loading-spinner"></div>
    <p>Cargando carrito...</p>
  </div>

  <!-- ========== PASO 0: CARRITO ========== -->
  <div
    class="carrito-content"
    *ngIf="!cargando && pasoActual === 0 && carrito && carrito.items.length > 0"
  >
    <div class="container">
      <div class="carrito-layout">
        <!-- PRODUCTOS -->
        <div class="productos-columna">
          <div class="section-header">
            <h2 class="section-title">Productos en tu carrito</h2>
            <button class="btn-vaciar btn-glow-subtle" (click)="vaciarCarrito()">
              <i class="material-icons">delete_sweep</i>
              <span class="btn-text">Vaciar Carrito</span>
            </button>
          </div>

          <div class="productos-list">
            <div *ngFor="let item of carrito.items" class="producto-card">
              <!-- Imagen -->
              <div class="producto-imagen">
                <img [src]="getProductImage(item)" [alt]="item.product.titulo" />
                <div class="producto-badges">
                  <span class="badge badge-categoria">{{ item.product.category.nombre }}</span>
                </div>
              </div>

              <!-- Información -->
              <div class="producto-info">
                <div class="producto-header">
                  <h3 class="producto-nombre">{{ item.product.titulo }}</h3>
                  <button class="btn-eliminar btn-glow-subtle" (click)="eliminarProducto(item)">
                    <i class="material-icons">close</i>
                  </button>
                </div>

                <p class="producto-desc">
                  {{
                    item.product.descripcion.length > 100
                      ? (item.product.descripcion | slice: 0 : 100) + '...'
                      : item.product.descripcion
                  }}
                </p>

                <div class="producto-artesano">
                  <i class="material-icons">palette</i>
                  <span class="artesano-nombre">{{ item.product.seller?.fullName }}</span>
                </div>

                <div class="producto-precio-unitario">
                  <span class="precio-label">Precio unitario:</span>
                  <span class="precio-valor">{{
                    item.precioUnitario | currency: 'MXN' : 'symbol'
                  }}</span>
                </div>

                <div class="producto-stock" [class.low-stock]="item.product.stock < 5">
                  <i class="material-icons">inventory_2</i>
                  <span>{{ item.product.stock }} disponibles</span>
                </div>
              </div>

              <!-- Controles -->
              <div class="producto-cantidad">
                <div class="cantidad-controls">
                  <button
                    class="btn-cantidad btn-glow-subtle"
                    (click)="disminuirCantidad(item)"
                    [disabled]="item.cantidad <= 1"
                  >
                    <i class="material-icons">remove</i>
                  </button>

                  <div class="cantidad-display">
                    <span class="cantidad-numero">{{ item.cantidad }}</span>
                    <span class="cantidad-texto">unidades</span>
                  </div>

                  <button
                    class="btn-cantidad btn-glow-subtle"
                    (click)="aumentarCantidad(item)"
                    [disabled]="item.cantidad >= item.product.stock"
                  >
                    <i class="material-icons">add</i>
                  </button>
                </div>

                <div class="producto-subtotal">
                  <span class="subtotal-label">Subtotal:</span>
                  <span class="subtotal-valor">{{
                    item.subtotal | currency: 'MXN' : 'symbol'
                  }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RESUMEN -->
        <div class="resumen-columna">
          <div class="resumen-card">
            <h3 class="resumen-title">Resumen del Pedido</h3>

            <div class="resumen-detalles">
              <div class="detalle-linea">
                <span class="detalle-label">Subtotal</span>
                <span class="detalle-valor">{{
                  calcularSubtotal() | currency: 'MXN' : 'symbol'
                }}</span>
              </div>

              <div class="detalle-linea">
                <span class="detalle-label">Envío</span>
                <span class="detalle-valor envio-gratis" *ngIf="calcularEnvio() === 0">
                  <i class="material-icons">local_shipping</i> ¡Gratis!
                </span>
                <span class="detalle-valor" *ngIf="calcularEnvio() > 0">
                  {{ calcularEnvio() | currency: 'MXN' : 'symbol' }}
                </span>
              </div>

              <div class="detalle-linea descuento" *ngIf="calcularDescuento() > 0">
                <span class="detalle-label">Descuento</span>
                <span class="detalle-valor"
                  >-{{ calcularDescuento() | currency: 'MXN' : 'symbol' }}</span
                >
              </div>

              <div class="detalle-linea cupon" *ngIf="cuponAplicado">
                <span class="detalle-label">Cupón aplicado</span>
                <span class="detalle-valor cupon-texto">
                  {{ carrito.codigoCupon }}
                  <button class="btn-remover-cupon" (click)="removerCupon()">
                    <i class="material-icons">close</i>
                  </button>
                </span>
              </div>
            </div>

            <!-- Cupón -->
            <div class="cupon-section" *ngIf="!cuponAplicado">
              <div class="cupon-input">
                <input
                  type="text"
                  placeholder="Código de cupón"
                  [(ngModel)]="codigoCupon"
                  class="form-input"
                  [disabled]="aplicandoCupon"
                />
                <button
                  class="btn-cupon btn-glow-effect"
                  (click)="aplicarCupon()"
                  [disabled]="aplicandoCupon || !codigoCupon"
                >
                  <i class="material-icons">local_offer</i>
                  {{ aplicandoCupon ? 'Aplicando...' : 'Aplicar' }}
                </button>
              </div>
            </div>

            <!-- Total -->
            <div class="resumen-total">
              <div class="total-label">Total a pagar</div>
              <div class="total-valor">{{ calcularTotal() | currency: 'MXN' : 'symbol' }}</div>
              <div class="total-nota">IVA incluido</div>
            </div>

            <!-- Acciones -->
            <div class="resumen-actions">
              <button class="btn-comprar btn-glow-effect" (click)="siguientePaso()">
                <i class="material-icons">arrow_forward</i>
                <span class="btn-text">Continuar</span>
              </button>

              <button class="btn-seguir btn-glow-subtle" routerLink="/marketplace">
                <i class="material-icons">arrow_back</i>
                <span class="btn-text">Seguir Comprando</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== PASO 1: DATOS DE ENVÍO ========== -->
  <div class="datos-envio-content" *ngIf="!cargando && pasoActual === 1">
    <div class="container">
      <div class="datos-layout">
        <div class="form-columna">
          <h2 class="section-title">Información de Envío</h2>

          <form class="envio-form">
            <div class="form-group">
              <label>
                <i class="material-icons">person</i>
                Nombre completo *
              </label>
              <input
                type="text"
                class="form-input"
                [(ngModel)]="datosEnvio.nombre"
                name="nombre"
                placeholder="Juan Pérez García"
                required
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <i class="material-icons">email</i>
                  Correo electrónico *
                </label>
                <input
                  type="email"
                  class="form-input"
                  [(ngModel)]="datosEnvio.email"
                  name="email"
                  placeholder="correo@ejemplo.com"
                  required
                />
              </div>

              <div class="form-group">
                <label>
                  <i class="material-icons">phone</i>
                  Teléfono *
                </label>
                <input
                  type="tel"
                  class="form-input"
                  [(ngModel)]="datosEnvio.telefono"
                  name="telefono"
                  placeholder="5512345678"
                  maxlength="10"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label>
                <i class="material-icons">home</i>
                Dirección *
              </label>
              <input
                type="text"
                class="form-input"
                [(ngModel)]="datosEnvio.direccion"
                name="direccion"
                placeholder="Calle, número, colonia"
                required
              />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <i class="material-icons">location_city</i>
                  Ciudad *
                </label>
                <input
                  type="text"
                  class="form-input"
                  [(ngModel)]="datosEnvio.ciudad"
                  name="ciudad"
                  placeholder="Ciudad de México"
                  required
                />
              </div>

              <div class="form-group">
                <label>
                  <i class="material-icons">map</i>
                  Estado *
                </label>
                <input
                  type="text"
                  class="form-input"
                  [(ngModel)]="datosEnvio.estado"
                  name="estado"
                  placeholder="CDMX"
                  required
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>
                  <i class="material-icons">markunread_mailbox</i>
                  Código Postal *
                </label>
                <input
                  type="text"
                  class="form-input"
                  [(ngModel)]="datosEnvio.codigoPostal"
                  name="codigoPostal"
                  placeholder="01000"
                  maxlength="5"
                  required
                />
              </div>

              <div class="form-group">
                <label>
                  <i class="material-icons">flag</i>
                  País
                </label>
                <input
                  type="text"
                  class="form-input"
                  [(ngModel)]="datosEnvio.pais"
                  name="pais"
                  value="México"
                  readonly
                />
              </div>
            </div>

            <div class="form-actions">
              <button type="button" class="btn-volver btn-glow-subtle" (click)="pasoAnterior()">
                <i class="material-icons">arrow_back</i>
                Volver
              </button>

              <button type="button" class="btn-continuar btn-glow-effect" (click)="siguientePaso()">
                <i class="material-icons">arrow_forward</i>
                Continuar a Pago
              </button>
            </div>
          </form>
        </div>

        <!-- Resumen lateral -->
        <div class="resumen-lateral">
          <div class="resumen-card">
            <h3 class="resumen-title">Resumen</h3>
            <div class="resumen-detalles">
              <div class="detalle-linea">
                <span>Subtotal</span>
                <span>{{ calcularSubtotal() | currency: 'MXN' : 'symbol' }}</span>
              </div>
              <div class="detalle-linea">
                <span>Envío</span>
                <span>{{ calcularEnvio() | currency: 'MXN' : 'symbol' }}</span>
              </div>
              <div class="resumen-total">
                <div class="total-label">Total</div>
                <div class="total-valor">{{ calcularTotal() | currency: 'MXN' : 'symbol' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== PASO 2: PAGO CON PAYPAL ========== -->
  <div class="pago-content" *ngIf="!cargando && pasoActual === 2">
    <div class="container">
      <div class="pago-layout">
        <div class="pago-columna">
          <h2 class="section-title">Método de Pago</h2>

          <div class="paypal-section">
            <div class="paypal-info">
              <div class="paypal-logo">
                <img
                  src="https://www.paypalobjects.com/webstatic/mktg/logo/AM_mc_vs_dc_ae.jpg"
                  alt="PayPal"
                />
              </div>
              <p class="paypal-desc">
                <i class="material-icons">security</i>
                Paga de forma segura con PayPal. Acepta tarjetas de crédito, débito y saldo PayPal.
              </p>
            </div>

            <!-- Contenedor del botón de PayPal -->
            <div id="paypal-button-container" class="paypal-button-wrapper"></div>

            <div class="pago-nota">
              <i class="material-icons">info</i>
              <span>Serás redirigido a PayPal para completar el pago de forma segura.</span>
            </div>

            <!-- Loading de procesamiento -->
            <div class="procesando-overlay" *ngIf="procesandoPago">
              <div class="procesando-content">
                <div class="loading-spinner"></div>
                <p>Procesando pago...</p>
              </div>
            </div>
          </div>

          <div class="pago-actions">
            <button
              class="btn-volver btn-glow-subtle"
              (click)="pasoAnterior()"
              [disabled]="procesandoPago"
            >
              <i class="material-icons">arrow_back</i>
              Volver
            </button>
          </div>
        </div>

        <!-- Resumen lateral -->
        <div class="resumen-lateral">
          <div class="resumen-card">
            <h3 class="resumen-title">Resumen Final</h3>

            <div class="envio-info">
              <h4><i class="material-icons">local_shipping</i> Envío a:</h4>
              <p>{{ datosEnvio.nombre }}</p>
              <p>{{ datosEnvio.direccion }}</p>
              <p>{{ datosEnvio.ciudad }}, {{ datosEnvio.estado }} {{ datosEnvio.codigoPostal }}</p>
            </div>

            <div class="resumen-detalles">
              <div class="detalle-linea">
                <span>Subtotal</span>
                <span>{{ calcularSubtotal() | currency: 'MXN' : 'symbol' }}</span>
              </div>
              <div class="detalle-linea">
                <span>Envío</span>
                <span>{{ calcularEnvio() | currency: 'MXN' : 'symbol' }}</span>
              </div>
              <div class="detalle-linea descuento" *ngIf="calcularDescuento() > 0">
                <span>Descuento</span>
                <span>-{{ calcularDescuento() | currency: 'MXN' : 'symbol' }}</span>
              </div>
              <div class="resumen-total">
                <div class="total-label">Total a pagar</div>
                <div class="total-valor">{{ calcularTotal() | currency: 'MXN' : 'symbol' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== PASO 3: CONFIRMACIÓN ========== -->
  <div class="confirmacion-content" *ngIf="!cargando && pasoActual === 3 && ordenConfirmada">
    <div class="container">
      <div class="confirmacion-success">
        <div class="success-icon">
          <i class="material-icons">check_circle</i>
        </div>

        <h1 class="success-title">¡Compra realizada con éxito!</h1>
        <p class="success-desc">
          Gracias por tu compra. Recibirás un correo de confirmación en breve.
        </p>

        <div class="orden-info">
          <div class="info-card">
            <h3>
              <i class="material-icons">receipt</i>
              Número de Orden
            </h3>
            <p class="orden-number">{{ ordenConfirmada.orderNumber }}</p>
          </div>

          <div class="info-card">
            <h3>
              <i class="material-icons">payments</i>
              Total Pagado
            </h3>
            <p class="total-pagado">{{ ordenConfirmada.total | currency: 'MXN' : 'symbol' }}</p>
          </div>
        </div>

        <div class="confirmacion-actions">
          <button
            class="btn-ver-orden btn-glow-effect"
            [routerLink]="['/ordenes', ordenConfirmada.id]"
          >
            <i class="material-icons">visibility</i>
            Ver Detalles de la Orden
          </button>

          <button class="btn-nueva-compra btn-glow-subtle" (click)="reiniciarCompra()">
            <i class="material-icons">shopping_cart</i>
            Hacer Nueva Compra
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== CARRITO VACÍO ========== -->
  <div
    class="carrito-vacio"
    *ngIf="!cargando && pasoActual === 0 && (!carrito || carrito.items.length === 0)"
  >
    <div class="container">
      <div class="vacio-content">
        <div class="vacio-icon">
          <i class="material-icons">shopping_cart</i>
        </div>
        <h3 class="vacio-title">Tu carrito está vacío</h3>
        <p class="vacio-desc">Agrega algunos productos artesanales para comenzar</p>
        <div class="vacio-actions">
          <button class="btn-explorar btn-glow-effect" routerLink="/marketplace">
            <i class="material-icons">explore</i>
            <span class="btn-text">Explorar Productos</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
